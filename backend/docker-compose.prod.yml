# Production Docker Compose configuration
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up

services:
  # Production Zookeeper configuration
  zookeeper:
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
        max_attempts: 3

  # Production Kafka configuration
  kafka:
    environment:
      # Production-specific Kafka settings
      KAFKA_LOG_RETENTION_HOURS: 168  # 7 days
      KAFKA_LOG_SEGMENT_BYTES: 1073741824  # 1GB
      KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS: 300000
      KAFKA_COMPRESSION_TYPE: 'snappy'
      KAFKA_NUM_NETWORK_THREADS: 8
      KAFKA_NUM_IO_THREADS: 8
      KAFKA_SOCKET_SEND_BUFFER_BYTES: 102400
      KAFKA_SOCKET_RECEIVE_BUFFER_BYTES: 102400
      KAFKA_SOCKET_REQUEST_MAX_BYTES: 104857600
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
      restart_policy:
        condition: on-failure
        max_attempts: 3

  # Production PostgreSQL configuration
  postgres:
    environment:
      POSTGRES_DB: virtual_garage
      POSTGRES_USER: virtual_garage
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-garage123}  # Use env var or default
      # Production tuning
      POSTGRES_SHARED_PRELOAD_LIBRARIES: 'pg_stat_statements'
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
      -c max_connections=300
      -c shared_buffers=512MB
      -c effective_cache_size=2GB
      -c work_mem=8MB
      -c maintenance_work_mem=128MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c temp_file_limit=4GB
      -c log_min_duration_statement=2000
      -c log_connections=off
      -c log_disconnections=off
      -c log_lock_waits=on
      -c log_statement=none
      -c log_line_prefix='%t [%p]: [%l-1] user=%u,db=%d '
      -c autovacuum=on
      -c autovacuum_max_workers=3
      -c autovacuum_naptime=1min
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      # Production backup location
      - /var/backups/virtual-garage/postgres:/backups
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
      restart_policy:
        condition: on-failure
        max_attempts: 3

  # Production Virtual Garage API configuration
  virtual-garage-api:
    environment:
      SPRING_PROFILES_ACTIVE: docker,prod
      JAVA_OPTS: >-
        -server
        -Xms1g
        -Xmx2g
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=100
        -XX:+UseStringDeduplication
        -XX:+DisableExplicitGC
        -XX:+UseContainerSupport
        -XX:MaxRAMPercentage=80.0
        -Djava.awt.headless=true
        -Djava.security.egd=file:/dev/./urandom
        -Dlogging.level.com.virtualgarage=INFO
        -Dlogging.level.org.hibernate.SQL=WARN
        -Dspring.jpa.show-sql=false
    volumes:
      - app-logs:/app/logs
      - app-uploads:/app/uploads
      # Production backup location
      - /var/backups/virtual-garage/uploads:/backups
    deploy:
      resources:
        limits:
          memory: 2.5G
        reservations:
          memory: 1G
      restart_policy:
        condition: on-failure
        max_attempts: 5
    # Remove health check in production (handled by orchestrator)
    healthcheck:
      disable: true
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # Remove development tools in production
  kafka-ui:
    profiles:
      - never

  pgadmin:
    profiles:
      - never

# Production volume configuration
volumes:
  postgres-data:
    driver: local
    name: virtual-garage-postgres-data-prod
    driver_opts:
      type: none
      o: bind
      device: /var/lib/virtual-garage/postgres

  kafka-data:
    driver: local
    name: virtual-garage-kafka-data-prod
    driver_opts:
      type: none
      o: bind
      device: /var/lib/virtual-garage/kafka

  app-logs:
    driver: local
    name: virtual-garage-app-logs-prod
    driver_opts:
      type: none
      o: bind
      device: /var/log/virtual-garage

  app-uploads:
    driver: local
    name: virtual-garage-app-uploads-prod
    driver_opts:
      type: none
      o: bind
      device: /var/lib/virtual-garage/uploads